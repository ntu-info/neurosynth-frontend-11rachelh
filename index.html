<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Neurosynth Web Frontend</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .btn-custom {
      background-color: #0d6efd;
      color: white;
      margin-right: 5px;
    }
    .btn-custom.active {
      background-color: white;
      color: #0d6efd;
      border: 1px solid #0d6efd;
    }
    .btn-custom:hover:not(.active) {
      background-color: #0b5ed7;
      color: white;
    }
    .loading-spinner {
      display: inline-block;
      width: 1.5rem;
      height: 1.5rem;
      border: 0.25em solid rgba(0,0,0,.1);
      border-top-color: #0d6efd;
      border-radius: 50%;
      animation: spinner 0.75s linear infinite;
    }
    @keyframes spinner {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-light">

<div class="container py-4">
  <h1 class="mb-3">Neurosynth Web Frontend</h1>

  <div class="mb-3">
    <button id="btnTermsAll" class="btn btn-custom">Look up all terms</button>
    <button id="btnTermsOne" class="btn btn-custom">Look up a term</button>
    <button id="btnLogical" class="btn btn-custom">Logical search</button>
  </div>

  <div id="searchDiv" class="mb-3" style="display:none;">
    <input id="searchInput" type="text" class="form-control" placeholder="Enter term...">
  </div>

  <div id="output" class="p-3 bg-white border rounded" style="max-height: 400px; overflow:auto;">
    Select a function to start.
  </div>
</div>

<script>
const btnTermsAll = document.getElementById('btnTermsAll');
const btnTermsOne = document.getElementById('btnTermsOne');
const btnLogical = document.getElementById('btnLogical');
const searchDiv = document.getElementById('searchDiv');
const searchInput = document.getElementById('searchInput');
const output = document.getElementById('output');

let activeBtn = null;
let debounceTimeout = null;

// 切換按鈕狀態
function setActiveButton(btn) {
  [btnTermsAll, btnTermsOne, btnLogical].forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  activeBtn = btn;
  searchInput.value = '';
  output.innerHTML = '';
  searchDiv.style.display = (btn === btnTermsOne || btn === btnLogical) ? 'block' : 'none';
}

// loading spinner
function showLoading() {
  output.innerHTML = '<div class="loading-spinner"></div> Loading...';
}

// 1. Look up all terms
async function fetchTermsAll() {
  showLoading();
  try {
    const resp = await fetch('https://hpc.psy.ntu.edu.tw:5000/terms');
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const data = await resp.json();
    if (!data.terms || data.terms.length === 0) {
      output.innerHTML = 'No results found.';
      return;
    }
    const list = data.terms.map(t => `<li>${t}</li>`).join('');
    output.innerHTML = `<ul>${list}</ul>`;
  } catch (err) {
    output.textContent = 'Error: ' + err.message;
  }
}

// 2. Look up a term
async function fetchTerm(term) {
  if (!term) {
    output.innerHTML = '';
    return;
  }
  showLoading();
  try {
    const resp = await fetch(`https://hpc.psy.ntu.edu.tw:5000/terms/${term}`);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const data = await resp.json();
    if (!data.related || data.related.length === 0) {
      output.innerHTML = 'No results found.';
      return;
    }
    const rows = data.related.map(r => `
      <tr>
        <td>${r.term}</td>
        <td>${r.co_count}</td>
        <td>${r.jaccard.toFixed(3)}</td>
      </tr>`).join('');
    output.innerHTML = `
      <table class="table table-bordered table-striped table-hover">
        <thead class="table-primary">
          <tr>
            <th>Term</th>
            <th>Co_count</th>
            <th>Jaccard</th>
          </tr>
        </thead>
        <tbody>
          ${rows}
        </tbody>
      </table>`;
  } catch (err) {
    output.textContent = 'Error: ' + err.message;
  }
}

// 3. Logical search
async function fetchLogical(term) {
  if (!term) {
    output.innerHTML = '';
    return;
  }
  showLoading();
  try {
    const resp = await fetch(`https://hpc.psy.ntu.edu.tw:5000/query/${term}/studies`);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const data = await resp.json();
    if (!data.results || data.results.length === 0) {
      output.innerHTML = 'No results found.';
      return;
    }
    const rows = data.results.map(r => `
      <tr>
        <td>${r.authors}</td>
        <td>${r.contrast_id}</td>
        <td>${r.id}</td>
        <td>${r.journal}</td>
        <td>${r.study_id}</td>
        <td>${r.title}</td>
        <td>${r.year}</td>
      </tr>`).join('');
    output.innerHTML = `
      <table class="table table-bordered table-striped table-hover">
        <thead class="table-primary">
          <tr>
            <th>Authors</th>
            <th>Contrast ID</th>
            <th>ID</th>
            <th>Journal</th>
            <th>Study ID</th>
            <th>Title</th>
            <th>Year</th>
          </tr>
        </thead>
        <tbody>
          ${rows}
        </tbody>
      </table>`;
  } catch (err) {
    output.textContent = 'Error: ' + err.message;
  }
}

// 按鈕事件
btnTermsAll.addEventListener('click', () => {
  setActiveButton(btnTermsAll);
  fetchTermsAll();
});
btnTermsOne.addEventListener('click', () => setActiveButton(btnTermsOne));
btnLogical.addEventListener('click', () => setActiveButton(btnLogical));

// AJAX 即時搜尋（debounce 300ms）
searchInput.addEventListener('input', () => {
  if (debounceTimeout) clearTimeout(debounceTimeout);
  debounceTimeout = setTimeout(() => {
    const term = searchInput.value.trim();
    if (!term) return;
    if (activeBtn === btnTermsOne) fetchTerm(term);
    else if (activeBtn === btnLogical) fetchLogical(term);
  }, 300);
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
